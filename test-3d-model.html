<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Three.js Model Test</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #f0f0f0;
        }

        canvas {
            display: block;
        }

        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            max-width: 400px;
            font-size: 12px;
        }

        #error {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 0, 0, 0.9);
            color: #fff;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            max-width: 400px;
            font-size: 12px;
            display: none;
        }
    </style>
</head>

<body>
    <div id="info">
        <div>Loading model...</div>
        <div id="status"></div>
    </div>
    <div id="error"></div>

    <script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.module.js",
    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.158.0/examples/jsm/"
  }
}
</script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // Setup scene, camera, renderer
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0xcccccc);

        const camera = new THREE.PerspectiveCamera(
            75,
            window.innerWidth / window.innerHeight,
            0.1,
            1000
        );
        camera.position.set(3, 3, 3);
        camera.lookAt(0, 0, 0);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        // Setup OrbitControls
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.target.set(0, 0.5, 0);

        // Add lights
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);

        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(5, 10, 5);
        directionalLight.castShadow = true;
        scene.add(directionalLight);

        // Add ground plane
        const planeGeo = new THREE.PlaneGeometry(20, 20);
        const planeMat = new THREE.MeshStandardMaterial({ color: 0xdddddd });
        const plane = new THREE.Mesh(planeGeo, planeMat);
        plane.rotation.x = -Math.PI / 2;
        scene.add(plane);

        // Load model
        const loader = new GLTFLoader();
        const status = document.getElementById('status');
        const errorDiv = document.getElementById('error');

        loader.load(
            "https://xvbtzrpbaxcvaawhphto.supabase.co/storage/v1/object/public/models/bedroom/king_floor_bed.glb",
            (gltf) => {
                console.log("Model loaded successfully", gltf);
                const model = gltf.scene;

                // Compute bounding box
                const box = new THREE.Box3().setFromObject(model);
                const size = new THREE.Vector3();
                box.getSize(size);

                // Scale model proportionally
                const maxDim = Math.max(size.x, size.y, size.z);
                const scale = 2 / maxDim;
                model.scale.setScalar(scale);

                // Recompute bounding box after scaling
                box.setFromObject(model);
                const center = new THREE.Vector3();
                box.getCenter(center);

                // Center model at origin
                model.position.sub(center);

                scene.add(model);
                status.innerHTML = "âœ“ Model loaded successfully<br>Vertices: " + (gltf.scene.children[0]?.geometry?.attributes?.position?.count || 'N/A');
            },
            (progress) => {
                const percent = (progress.loaded / progress.total * 100).toFixed(2);
                status.innerHTML = `Loading: ${percent}%`;
                console.log('Loading progress:', percent + '%');
            },
            (error) => {
                console.error("Error loading model:", error);
                errorDiv.style.display = 'block';
                errorDiv.innerHTML = `<strong>Error loading model:</strong><br>${error.message}`;
            }
        );

        // Animation loop
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        animate();

        // Handle window resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>

</html>